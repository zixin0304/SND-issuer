<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>KFD XRPL ç™¼å¹£å°ï¼ˆå¾Œç«¯ç°½åï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0f0f23;color:#eee;margin:0;padding:24px}
    .card{max-width:860px;margin:0 auto;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px}
    h1{margin:0 0 6px}
    small{color:#aaa}
    label{display:block;margin:12px 0 6px;color:#ccc}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff}
    textarea{min-height:120px}
    button{margin-top:12px;background:#667eea;border:0;color:#fff;padding:12px 18px;border-radius:10px;cursor:pointer}
    .log{margin-top:18px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;white-space:pre-wrap;background:rgba(0,0,0,.3);padding:12px;border-radius:10px}
    .section{margin-top:32px;padding-top:16px;border-top:1px solid rgba(255,255,255,.15)}
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸš€ KFD XRPL ç™¼å¹£å°</h1>
    <small>å¾Œç«¯ç”¨ <code>.env</code> çš„ <b>ISSUER_SECRET/ISSUER_ADDRESS</b> ç°½åï¼›å‰ç«¯ä¸æ¥è§¸ç§é‘°ã€‚</small>

    <div class="section">
      <h2>å–®ç­†ç™¼å¹£</h2>
      <label>æ¥æ”¶åœ°å€ï¼ˆr...ï¼‰</label>
      <input id="addr" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXX" />
      <label>æ•¸é‡</label>
      <input id="amt" type="number" min="0" step="0.000001" placeholder="100" />
      <button onclick="mintSingle()">ç«‹å³ç™¼å¹£</button>
    </div>

    <div class="section">
      <h2>æ‰¹æ¬¡ç™¼å¹£</h2>
      <label>ä¸€è¡Œä¸€ç­†ï¼šåœ°å€,æ•¸é‡</label>
      <textarea id="batch" placeholder="r...,100
r...,250
r...,10.5"></textarea>
      <button onclick="mintBatch()">æ‰¹æ¬¡ç™¼å¹£</button>
    </div>

    <div class="section">
      <h2>ä¸€éµå»ºç«‹ä¿¡ä»»ç·š (XUMM)</h2>
      <label>ä¿¡ä»»ç·šé¡åº¦</label>
      <input id="trustLimit" type="number" value="1000000" min="1" />
      <button onclick="createTrustline()">å»ºç«‹ä¿¡ä»»ç·š</button>

      <div id="xummArea" style="display:none;margin-top:12px;">
        <p>ç”¨æ‰‹æ©Ÿé–‹ Xaman æƒæä¸‹æ–¹ QRï¼Œæˆ–ç›´æ¥é»é€£çµï¼š</p>
        <p><a id="xummLink" href="#" target="_blank" rel="noopener">åœ¨ Xaman é–‹å•Ÿç°½å</a></p>
        <img id="xummQR" alt="XUMM QR" style="max-width:220px;border:1px solid #ccc;border-radius:8px;">
        <p id="xummStatus">ç­‰å¾…ç°½åä¸­â€¦</p>
      </div>

      <div id="trustCheck" style="display:none;margin-top:12px;padding:10px;background:#f6f9ff;color:#000;border-radius:8px;">
        <div>ç°½åå¸³è™Ÿï¼š<code id="signedAccount"></code></div>
        <div>ä¿¡ä»»ç·šç‹€æ…‹ï¼š<code id="trustlineStatus"></code></div>
      </div>
    </div>

    <div class="log" id="log">å¾…å‘½ä¸­â€¦</div>
  </div>

  <script>
    const API = location.origin.replace(/\/$/, "");
    const log = (m) => (document.getElementById('log').textContent = m);

    async function mintSingle() {
      const to = document.getElementById('addr').value.trim();
      const amount = document.getElementById('amt').value.trim();
      log("é€å‡ºä¸­â€¦");
      try {
        const r = await fetch(`${API}/api/kfd/mint-single`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ to, amount })
        });
        const j = await r.json();
        if (!r.ok || j.status !== "success") throw new Error(j.message || "mint å¤±æ•—");
        log(`âœ… æˆåŠŸ\nTX: ${j.hash}`);
      } catch (e) { log("âŒ " + e.message); }
    }

    async function mintBatch() {
      const lines = document.getElementById('batch').value.trim().split(/\n+/).filter(Boolean);
      const items = lines.map((L, i) => {
        const [to, amount] = L.split(/[, \t]+/).map(s => s.trim());
        if (!to || !amount) throw new Error(`ç¬¬ ${i+1} è¡Œæ ¼å¼éŒ¯èª¤`);
        return { to, amount };
      });
      log("æ‰¹æ¬¡é€å‡ºä¸­â€¦");
      try {
        const r = await fetch(`${API}/api/kfd/mint-batch`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || "batch å¤±æ•—");
        const lines = j.results.map((x,i)=> 
          `${i+1}. ${x.ok ? "âœ…" : "âŒ"} ${x.to} â† ${x.amount} ${x.hash||""} ${x.error||""}`
        ).join("\n");
        log(`æ‰¹æ¬¡å®Œæˆ\n${lines}`);
      } catch (e) { log("âŒ " + e.message); }
    }

    // ====== ä¸€éµå»ºç«‹ä¿¡ä»»ç·š (XUMM) ======
    let pollTimer = null;
    async function createTrustline() {
      clearInterval(pollTimer);
      document.getElementById('trustCheck').style.display = 'none';
      document.getElementById('xummArea').style.display = 'none';
      document.getElementById('xummStatus').textContent = 'ç­‰å¾…ç°½åä¸­â€¦';

      const limit = Number(document.getElementById('trustLimit').value || 1000000);
      try {
        const resp = await fetch(`${API}/api/xumm/trustset-payload`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ limit })
        }).then(r=>r.json());

        if (!resp.ok) throw new Error(resp.error || "payload å»ºç«‹å¤±æ•—");
        document.getElementById('xummLink').href = resp.link;
        document.getElementById('xummQR').src = resp.qr;
        document.getElementById('xummArea').style.display = 'block';

        pollTimer = setInterval(async ()=>{
          const st = await fetch(`${API}/api/xumm/trustset-status?uuid=${encodeURIComponent(resp.uuid)}`)
            .then(r=>r.json()).catch(()=>({}));
          if (!st.ok) return;
          if (st.expired) {
            document.getElementById('xummStatus').textContent = 'ç°½åå·²éæœŸ';
            clearInterval(pollTimer);
            return;
          }
          if (st.signed) {
            document.getElementById('xummStatus').textContent = 'ç°½åå®Œæˆ âœ…';
            clearInterval(pollTimer);

            // é¡¯ç¤ºç°½åè€…å¸³è™Ÿä¸¦å³æ™‚æª¢æŸ¥ä¿¡ä»»ç·š
            const acct = st.account;
            document.getElementById('signedAccount').textContent = acct || '(æœªçŸ¥)';
            if (acct) {
              const tl = await fetch(`${API}/api/check-trustline?to=${encodeURIComponent(acct)}`)
                .then(r=>r.json()).catch(()=>({}));
              document.getElementById('trustlineStatus').textContent =
                (tl.ok && tl.hasTrustline) ? 'å·²å»ºç«‹ âœ…' : 'å°šæœªå»ºç«‹';
            }
            document.getElementById('trustCheck').style.display = 'block';
          }
        }, 1500);
      } catch (e) {
        alert("âŒ " + e.message);
      }
    }

    // ====== åˆå§‹åŒ–ï¼šå¥åº·æª¢æŸ¥ ======
    fetch(`${API}/api/health`).then(r=>r.json()).then(j=>{
      log(`å¾…å‘½ä¸­â€¦
ç™¼è¡Œè€…: ${j.issuer}
ä»£å¹£: ${j.currency}
XUMM: ${j.xummEnabled ? "å•Ÿç”¨" : "æœªå•Ÿç”¨"}`);
    }).catch(()=>{});
  </script>
</body>
</html>
