<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>KFD XRPL 發幣台（後端簽名）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0f0f23;color:#eee;margin:0;padding:24px}
    .card{max-width:860px;margin:0 auto;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px}
    h1{margin:0 0 6px}
    small{color:#aaa}
    label{display:block;margin:12px 0 6px;color:#ccc}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff}
    textarea{min-height:120px}
    button{margin-top:12px;background:#667eea;border:0;color:#fff;padding:12px 18px;border-radius:10px;cursor:pointer}
    .log{margin-top:18px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;white-space:pre-wrap;background:rgba(0,0,0,.3);padding:12px;border-radius:10px}
    .section{margin-top:32px;padding-top:16px;border-top:1px solid rgba(255,255,255,.15)}
  </style>
</head>
<body>
  <div class="card">
    <h1>🚀 KFD XRPL 發幣台</h1>
    <small>後端用 <code>.env</code> 的 <b>ISSUER_SECRET/ISSUER_ADDRESS</b> 簽名；前端不接觸私鑰。</small>

    <div class="section">
      <h2>單筆發幣</h2>
      <label>接收地址（r...）</label>
      <input id="addr" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXX" />
      <label>數量</label>
      <input id="amt" type="number" min="0" step="0.000001" placeholder="100" />
      <button onclick="mintSingle()">立即發幣</button>
    </div>

    <div class="section">
      <h2>批次發幣</h2>
      <label>一行一筆：地址,數量</label>
      <textarea id="batch" placeholder="r...,100
r...,250
r...,10.5"></textarea>
      <button onclick="mintBatch()">批次發幣</button>
    </div>

    <div class="section">
      <h2>一鍵建立信任線 (XUMM)</h2>
      <label>信任線額度</label>
      <input id="trustLimit" type="number" value="1000000" min="1" />
      <button onclick="createTrustline()">建立信任線</button>

      <div id="xummArea" style="display:none;margin-top:12px;">
        <p>用手機開 Xaman 掃描下方 QR，或直接點連結：</p>
        <p><a id="xummLink" href="#" target="_blank" rel="noopener">在 Xaman 開啟簽名</a></p>
        <img id="xummQR" alt="XUMM QR" style="max-width:220px;border:1px solid #ccc;border-radius:8px;">
        <p id="xummStatus">等待簽名中…</p>
      </div>

      <div id="trustCheck" style="display:none;margin-top:12px;padding:10px;background:#f6f9ff;color:#000;border-radius:8px;">
        <div>簽名帳號：<code id="signedAccount"></code></div>
        <div>信任線狀態：<code id="trustlineStatus"></code></div>
      </div>
    </div>

    <div class="log" id="log">待命中…</div>
  </div>

  <script>
    const API = location.origin.replace(/\/$/, "");
    const log = (m) => (document.getElementById('log').textContent = m);

    async function mintSingle() {
      const to = document.getElementById('addr').value.trim();
      const amount = document.getElementById('amt').value.trim();
      log("送出中…");
      try {
        const r = await fetch(`${API}/api/kfd/mint-single`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ to, amount })
        });
        const j = await r.json();
        if (!r.ok || j.status !== "success") throw new Error(j.message || "mint 失敗");
        log(`✅ 成功\nTX: ${j.hash}`);
      } catch (e) { log("❌ " + e.message); }
    }

    async function mintBatch() {
      const lines = document.getElementById('batch').value.trim().split(/\n+/).filter(Boolean);
      const items = lines.map((L, i) => {
        const [to, amount] = L.split(/[, \t]+/).map(s => s.trim());
        if (!to || !amount) throw new Error(`第 ${i+1} 行格式錯誤`);
        return { to, amount };
      });
      log("批次送出中…");
      try {
        const r = await fetch(`${API}/api/kfd/mint-batch`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || "batch 失敗");
        const lines = j.results.map((x,i)=> 
          `${i+1}. ${x.ok ? "✅" : "❌"} ${x.to} ← ${x.amount} ${x.hash||""} ${x.error||""}`
        ).join("\n");
        log(`批次完成\n${lines}`);
      } catch (e) { log("❌ " + e.message); }
    }

    // ====== 一鍵建立信任線 (XUMM) ======
    let pollTimer = null;
    async function createTrustline() {
      clearInterval(pollTimer);
      document.getElementById('trustCheck').style.display = 'none';
      document.getElementById('xummArea').style.display = 'none';
      document.getElementById('xummStatus').textContent = '等待簽名中…';

      const limit = Number(document.getElementById('trustLimit').value || 1000000);
      try {
        const resp = await fetch(`${API}/api/xumm/trustset-payload`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ limit })
        }).then(r=>r.json());

        if (!resp.ok) throw new Error(resp.error || "payload 建立失敗");
        document.getElementById('xummLink').href = resp.link;
        document.getElementById('xummQR').src = resp.qr;
        document.getElementById('xummArea').style.display = 'block';

        pollTimer = setInterval(async ()=>{
          const st = await fetch(`${API}/api/xumm/trustset-status?uuid=${encodeURIComponent(resp.uuid)}`)
            .then(r=>r.json()).catch(()=>({}));
          if (!st.ok) return;
          if (st.expired) {
            document.getElementById('xummStatus').textContent = '簽名已過期';
            clearInterval(pollTimer);
            return;
          }
          if (st.signed) {
            document.getElementById('xummStatus').textContent = '簽名完成 ✅';
            clearInterval(pollTimer);

            // 顯示簽名者帳號並即時檢查信任線
            const acct = st.account;
            document.getElementById('signedAccount').textContent = acct || '(未知)';
            if (acct) {
              const tl = await fetch(`${API}/api/check-trustline?to=${encodeURIComponent(acct)}`)
                .then(r=>r.json()).catch(()=>({}));
              document.getElementById('trustlineStatus').textContent =
                (tl.ok && tl.hasTrustline) ? '已建立 ✅' : '尚未建立';
            }
            document.getElementById('trustCheck').style.display = 'block';
          }
        }, 1500);
      } catch (e) {
        alert("❌ " + e.message);
      }
    }

    // ====== 初始化：健康檢查 ======
    fetch(`${API}/api/health`).then(r=>r.json()).then(j=>{
      log(`待命中…
發行者: ${j.issuer}
代幣: ${j.currency}
XUMM: ${j.xummEnabled ? "啟用" : "未啟用"}`);
    }).catch(()=>{});
  </script>
</body>
</html>
